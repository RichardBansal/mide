app.config(function($stateProvider){
	$stateProvider.state('challenge.code', {
		url : '/challenge/code',
		views: {
			'tab-code' : {
				templateUrl : 'features/challenge-code/challenge-code.html',
				controller : 'ChallengeCodeCtrl'
			}
		}
		// ,
		// onEnter : function(ChallengeFactory, $state){
		// 	if(ChallengeFactory.getProblem().length === 0){
		// 		$state.go('challenge.view');
		// 	}
		// }
	});
});

app.controller('ChallengeCodeCtrl', function($scope, $state, $rootScope, ChallengeFactory, ChallengeFooterFactory){

	setTimeout(function (){
		$scope.keyboardVis = window.cordova.plugins.Keyboard.isVisible;
			console.log("cordova isvis", window.cordova.plugins.Keyboard.isVisible);
			console.log("$scope keyboardVis", $scope.keyboardVis);


		if (window.cordova && window.cordova.plugins && window.cordova.plugins.Keyboard) {
			console.log("got in here");
		  window.cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);
		  window.cordova.plugins.Keyboard.disableScroll(true);
		}
	}, 500);

	$scope.footerHotkeys = ChallengeFooterFactory.getHotkeys();

	//Challenge Submit
	$scope.text = ChallengeFactory.getSubmission() || 'text';

	//initialize CodeMirror
	var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('code'), {
		lineNumbers : true,
		mode: 'javascript',
		autofocus : true,
		theme : 'twilight',
		lineWrapping: true
	});

	myCodeMirror.replaceSelection($scope.text);

	$scope.updateText = function(){
		$scope.text = myCodeMirror.getValue();
		//check if digest is in progress
		if(!$scope.$$phase) {
		  $scope.$apply();
		}
	};

	$scope.insertFunc = function(param){
		//given a param, will insert characters where cursor is
		console.log("inserting: ", param);
		myCodeMirror.replaceSelection(param);
		// window.cordova.plugins.Keyboard.show();
		myCodeMirror.focus();
	};

    myCodeMirror.on("change", function (myCodeMirror, changeObj){
    	$scope.updateText();
    });
    // myCodeMirror.on("cursorActivity", function (myCodeMirror, changeObj){
    // 	window.cordova.plugins.Keyboard.show();
    // 	$scope.keyboardVis = true;
    // 	$scope.$apply();
    // });
    window.addEventListener("native.keyboardshow", function (){
    	$scope.keyboardVis = true;
    	$scope.$apply();
    });
    window.addEventListener("native.keyboardhide", function (){
    	$scope.keyboardVis = false;
    	$scope.$apply();
    });

    // myCodeMirror.off("focus", function (myCodeMirror, changeObj){
    // 	$scope.keyboardVis = $window.cordova.plugins.Keyboard.isVisible;
    // });
	

	$scope.buttons = {
		compile : 'Compile',
		dismiss : 'Dismiss'
	};

	// $rootScope.$on('problemUpdated', function(e){
	// 	$scope.projectId = ChallengeFactory.getProblem().session.projectId;
	// 	$scope.solutionId = ChallengeFactory.getProblem().session.solutionId;
	// 	$scope.text = ChallengeFactory.getProblem().session.setup;
	// });

	$scope.compileChallenge = function(text){
		ChallengeFactory.setSubmission(text);
		$state.go('challenge.compile');
	};

	// $scope.dismissChallenge = function(){
	// 	var id = 'A9QKk6SmRpDcriU-HMQr';
	// 	ChallengeFactory.getChallenge(id).then(function(data){
	// 		$state.go('challenge.view');
	// 	});
	// };

});